# [Codeforces Round #737 (Div. 2)](https://codeforces.com/contest/1557/)

## A

最大值 + 其他的平均值即可

## B

直接贪心，然后看最小的数是否小于等于 k

## C

**分奇偶**

- $n$ 为奇数时，$a_i$ 始终有偶数个位置为 1（平局），或者全为全为 1 （平局）

$$
f_k = (C_n^0 + C_n^2 + \cdots + C_n^{n - 1} + 1) f_{k - 1}
$$

- $n$ 为偶数时，$a_i$ 的第 $j$ 为全为 1，此时后面的位随便搞，或者有偶数个位置第 $j$ 位为 1（此位置平局）
$$
f_k = 2^{(k - 1) n} + f_{k - 1}( C_n^0 + C_n^2 + \cdots + C_n^{n - 2})
$$

注意到 $(C_n^0 + C_n^2 + \cdots) = 2^{n - 1}$，我们设 $x = 2^{n - 1} - 1$
则 $f_k - \frac{(2x + 2)^k}{x + 2} = x \left(f_{k - 1} - \frac{(2x + 2)^{k - 1}}{x + 2} \right) = x^k (1 - \frac{1}{x + 2})$

> 注意到 $x + 2 \equiv 0 \mod M$，此时要另行处理

**所以最终次问题总结下来就是**：任意 $n, k, M$，算法复杂度为 $O(\log \max(n, k, M))$

- $n$ 为奇数时，答案为 $(1 + 2^{n - 1})^k$
- $n$ 为偶数时，$f_k = 2^{(k - 1) n} + f_{k - 1} (2^{n - 1} - 1), \; f_0 = 1$

注意到 $2^{kn} - (2^{n - 1} - 1) 2^{(k - 1)n} = 2^{(k - 1)n} (2^{n - 1} + 1)$

$$
f_k - \frac{2^{kn}}{2^{n - 1} + 1} = (2^{n - 1} - 1) \left( f_{k - 1} - \frac{2^{(k - 1)n}}{2^{n - 1} + 1} \right) = (2^{n - 1} - 1)^k (1 - \frac{1}{2^{n - 1} + 1})
$$
即答案为 $\frac{2^{kn} + (2^{n - 1} - 1)^k 2^{n - 1}}{2^{n - 1} + 1} = (2^{n - 1} - 1)^k + \frac{(2^n)^k - (2^{n - 1} - 1)^k}{2^n - (2^{n - 1} - 1)}$


若 $2^{n - 1} + 1 \equiv 0 \mod M$，那么
注意到此时 $2^n \equiv (2^{n - 1} - 1) \mod M$

因此答案就是 $2^{kn} + k \cdot 2^{n(k - 1)}$

> 注意若 $M$ 超了 int, 要使用 int128

## D

> 我一开始也有这个想法，但是感觉复杂度肯定过不了就没搞

设 $dp_{i, j}$ 表示（从 1 到 i）最大的行数使得它是 beautiful grid，且最后一行的 $j$ 位置为 1（我们不妨认为第 0 行全为 1）

那么按照定义

- $dp_{0, j} = 0$
- 若 $grid_{i, j} = 1$，此时 $dp_{i, j} = 1 + \max_{k \in C_i} dp_{i - 1, k}$（即此位置保留）
- 否则，$dp_{i, j} = dp_{i - 1, j}$

其中 $C_i$ 为 第 $i$ 行中值为 1 的位置，然后还要记录路径。

注意到在处理第 $i$ 行的时候只用处理 $grid_{i, j} = 1$ 的点，并且这些点的答案都是一致的。所以我们可以用 $pre_i$ 表示第 $i$ 行指向的行。

所以答案为两个指标：行数，前一行的行号

> 用线段树的使用：1. 动态开点的方式 2.先离散化再用线段树。主意可以先对区间做预处理变成每一行互不相交

哎，好久没写线段树了，Debug 了半天