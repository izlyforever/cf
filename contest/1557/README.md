# [Codeforces Round #737 (Div. 2)](https://codeforces.com/contest/1557/)

## A

最大值 + 其他的平均值即可

## B

直接贪心，然后看最小的数是否小于等于 k

## C

**分奇偶**

- $n$ 为奇数时，$a_i$ 始终有偶数个位置为 1（平局），或者全为全为 1 （平局）

$$
f_k = (C_n^0 + C_n^2 + \cdots + C_n^{n - 1} + 1) f_{k - 1}
$$

- $n$ 为偶数时，$a_i$ 的第 $j$ 为全为 1，此时后面的位随便搞，或者有偶数个位置第 $j$ 位为 1（此位置平局）
$$
f_k = 2^{(k - 1) n} + f_{k - 1}( C_n^0 + C_n^2 + \cdots + C_n^{n - 2})
$$

注意到 $(C_n^0 + C_n^2 + \cdots) = 2^{n - 1}$，我们设 $x = 2^{n - 1} - 1$
则 $f_k - \frac{(2x + 2)^k}{x + 2} = x \left(f_{k - 1} - \frac{(2x + 2)^{k - 1}}{x + 2} \right) = x^k (1 - \frac{1}{x + 2})$

> 注意到 $x + 2 \equiv 0 \mod M$，此时要另行处理

**所以最终次问题总结下来就是**：任意 $n, k, M$，算法复杂度为 $O(\log \max(n, k, M))$

- $n$ 为奇数时，答案为 $(1 + 2^{n - 1})^k$
- $n$ 为偶数时，$f_k = 2^{(k - 1) n} + f_{k - 1} (2^{n - 1} - 1), \; f_0 = 1$

注意到 $2^{kn} - (2^{n - 1} - 1) 2^{(k - 1)n} = 2^{(k - 1)n} (2^{n - 1} + 1)$

$$
f_k - \frac{2^{kn}}{2^{n - 1} + 1} = (2^{n - 1} - 1) \left( f_{k - 1} - \frac{2^{(k - 1)n}}{2^{n - 1} + 1} \right) = (2^{n - 1} - 1)^k (1 - \frac{1}{2^{n - 1} + 1})
$$
即答案为 $\frac{2^{kn} + (2^{n - 1} - 1)^k 2^{n - 1}}{2^{n - 1} + 1} = (2^{n - 1} - 1)^k + \frac{(2^n)^k - (2^{n - 1} - 1)^k}{2^n - (2^{n - 1} - 1)}$


若 $2^{n - 1} + 1 \equiv 0 \mod M$，那么
注意到此时 $2^n \equiv (2^{n - 1} - 1) \mod M$

因此答案就是 $2^{kn} + k \cdot 2^{n(k - 1)}$

> 注意若 $M$ 超了 int, 要使用 int128